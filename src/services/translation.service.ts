import { Injectable, signal } from '@angular/core';
import { MEANING_MAP, GRAMMAR_MAP, PARTICLE_MAP, GRAMMAR_FULL_MAP, PARTICLE_EXPLANATION_MAP, ContentLang } from './content-translations';

export type LanguageCode = 'ID' | 'EN' | 'VI' | 'TH' | 'PH' | 'MY';

@Injectable({ providedIn: 'root' })
export class TranslationService {
  currentLang = signal<LanguageCode>('ID');
  isDarkMode  = signal<boolean>(true);

  private dictionary: Record<LanguageCode, Record<string, string>> = {
    ID: {
      'app.name': 'NihongoQuest',
      'nav.home': 'Beranda', 'nav.vocab': 'Kamus', 'nav.writing': 'Menulis',
      'nav.profile': 'Profil', 'nav.settings': 'Pengaturan',
      'home.search_placeholder': 'Cari kanji, kosakata...',
      'home.start_learning': 'Mulai Belajar',
      'home.menu.kana': 'Kana', 'home.menu.kanji': 'Kanji',
      'home.menu.grammar': 'Tata Bahasa', 'home.menu.particles': 'Partikel',
      'home.menu.writing': 'Menulis', 'home.menu.vocab': 'Kosakata',
      'home.menu.quiz': 'Latihan Soal', 'home.menu.flashcard': 'Flashcard',
      'flashcard.title': 'Flashcard', 'flashcard.choose_deck': 'Pilih Dek Kartu',
      'flashcard.hiragana_deck': 'Dek Hiragana', 'flashcard.katakana_deck': 'Dek Katakana',
      'flashcard.kanji_deck': 'Dek Kanji', 'flashcard.vocab_deck': 'Dek Kosakata',
      'flashcard.shuffle': 'Acak Kartu', 'flashcard.card': 'Kartu', 'flashcard.of': 'dari',
      'flashcard.previous': 'Sebelumnya', 'flashcard.next': 'Selanjutnya',
      'flashcard.back_to_menu': 'Kembali ke Menu',
      'flashcard.custom_deck': 'Buat Dek Baru', 'flashcard.custom_deck_desc': 'Buat & simpan dek kustom Anda',
      'flashcard.config_title': 'Editor Dek Kustom', 'flashcard.select_sources': 'Pilih Sumber Kartu',
      'flashcard.card_quantity': 'Jumlah Kartu (1-500)', 'flashcard.start_session': 'Mulai Sesi',
      'flashcard.select_all': 'Pilih Semua', 'flashcard.deselect_all': 'Hapus Semua',
      'flashcard.deck_name': 'Nama Dek', 'flashcard.add_cards': 'Tambah Kartu',
      'flashcard.save_deck': 'Simpan Dek', 'flashcard.update_deck': 'Perbarui Dek',
      'flashcard.my_decks': 'Dek Kustom Saya', 'flashcard.search_to_add': 'Cari Kana, Kanji, Kosakata...',
      'flashcard.add': 'Tambah', 'flashcard.added': 'Ditambahkan',
      'flashcard.back_to_builder': 'Kembali ke Editor', 'flashcard.delete': 'Hapus',
      'flashcard.delete_confirm': 'Yakin ingin menghapus dek "{deckName}"?',
      'flashcard.edit': 'Edit', 'flashcard.start': 'Mulai',
      'flashcard.no_custom_decks': 'Belum ada dek kustom. Buat satu!',
      'flashcard.cards_in_deck': 'Kartu di Dalam Dek',
      'flashcard.browse_by_deck': 'Jelajahi berdasarkan Dek',
      'flashcard.clear_category': 'Hapus Filter',
      'flashcard.select_category_prompt': 'Pilih kategori di atas untuk melihat daftar kartu.',
      'flashcard.romaji_toggle': 'Romaji',
      'settings.title': 'Pengaturan', 'settings.language': 'Bahasa Aplikasi',
      'settings.theme': 'Tampilan', 'settings.dark_mode': 'Mode Gelap',
      'settings.about': 'Tentang Aplikasi', 'settings.reset': 'Reset Progress',
      'settings.reset_confirm': 'Apakah Anda yakin ingin menghapus semua progress?',
      'quiz.title': 'Latihan & Ujian', 'quiz.start': 'Mulai', 'quiz.score': 'Skor',
      'quiz.menu.particle': 'Latihan Partikel', 'quiz.menu.particle_desc': 'Isi partikel yang tepat',
      'common.level': 'Level', 'common.search': 'Cari...', 'common.back': 'Kembali',
      // Content labels
      'content.meaning': 'Arti', 'content.example': 'Contoh Kalimat',
      'content.reading': 'Cara Baca', 'content.on_reading': 'ONYOMI (Cina)',
      'content.kun_reading': 'KUNYOMI (Jepang)', 'content.strokes': 'Goresan',
      'content.story': 'Cerita Kanji', 'content.vocab_examples': 'Contoh Kosakata',
      'content.grammar': 'Tata Bahasa', 'content.formula': 'Pola / Rumus',
      'content.explanation': 'Penjelasan', 'content.particle_usage': 'Penggunaan',
      'content.level': 'Level', 'content.category': 'Kategori',
      'content.noun': 'Kata Benda', 'content.verb': 'Kata Kerja',
      'content.adj': 'Kata Sifat', 'content.other': 'Lain-lain', 'content.all': 'Semua',
      'content.search_kanji': 'Cari kanji, arti, atau cara baca...',
      'content.search_vocab': 'Cari kata (Jepang/Indo)...',
      'content.search_grammar': 'Cari tata bahasa, rumus, atau arti...',
      'content.no_kanji': 'Tidak ada kanji yang cocok dengan pencarian.',
      'content.no_vocab': 'Tidak ada kosakata di kategori ini.',
      'content.no_grammar': 'Tidak ada tata bahasa yang cocok.',
      'content.practice_write': 'Latihan Menulis',
      'content.detail': 'Detail', 'content.hide': 'Sembunyikan',
      'content.play': 'Putar', 'content.stop': 'Stop',
    },
    EN: {
      'app.name': 'NihongoQuest',
      'nav.home': 'Home', 'nav.vocab': 'Vocab', 'nav.writing': 'Write',
      'nav.profile': 'Profile', 'nav.settings': 'Settings',
      'home.search_placeholder': 'Search Kanji, Vocab...',
      'home.start_learning': 'Start Learning',
      'home.menu.kana': 'Kana', 'home.menu.kanji': 'Kanji',
      'home.menu.grammar': 'Grammar', 'home.menu.particles': 'Particles',
      'home.menu.writing': 'Writing', 'home.menu.vocab': 'Vocabulary',
      'home.menu.quiz': 'Quiz', 'home.menu.flashcard': 'Flashcard',
      'flashcard.title': 'Flashcard', 'flashcard.choose_deck': 'Choose a Deck',
      'flashcard.hiragana_deck': 'Hiragana Deck', 'flashcard.katakana_deck': 'Katakana Deck',
      'flashcard.kanji_deck': 'Kanji Deck', 'flashcard.vocab_deck': 'Vocab Deck',
      'flashcard.shuffle': 'Shuffle Cards', 'flashcard.card': 'Card', 'flashcard.of': 'of',
      'flashcard.previous': 'Previous', 'flashcard.next': 'Next',
      'flashcard.back_to_menu': 'Back to Menu',
      'flashcard.custom_deck': 'New Custom Deck', 'flashcard.custom_deck_desc': 'Create & save your own decks',
      'flashcard.config_title': 'Custom Deck Editor', 'flashcard.select_sources': 'Select Card Sources',
      'flashcard.card_quantity': 'Number of Cards (1-500)', 'flashcard.start_session': 'Start Session',
      'flashcard.select_all': 'Select All', 'flashcard.deselect_all': 'Deselect All',
      'flashcard.deck_name': 'Deck Name', 'flashcard.add_cards': 'Add Cards',
      'flashcard.save_deck': 'Save Deck', 'flashcard.update_deck': 'Update Deck',
      'flashcard.my_decks': 'My Custom Decks', 'flashcard.search_to_add': 'Search Kana, Kanji, Vocab...',
      'flashcard.add': 'Add', 'flashcard.added': 'Added',
      'flashcard.back_to_builder': 'Back to Editor', 'flashcard.delete': 'Delete',
      'flashcard.delete_confirm': 'Are you sure you want to delete deck "{deckName}"?',
      'flashcard.edit': 'Edit', 'flashcard.start': 'Start',
      'flashcard.no_custom_decks': 'No custom decks yet. Create one!',
      'flashcard.cards_in_deck': 'Cards in Deck',
      'flashcard.browse_by_deck': 'Browse by Deck',
      'flashcard.clear_category': 'Clear Filter',
      'flashcard.select_category_prompt': 'Select a category above to see the card list.',
      'flashcard.romaji_toggle': 'Romaji',
      'settings.title': 'Settings', 'settings.language': 'App Language',
      'settings.theme': 'Appearance', 'settings.dark_mode': 'Dark Mode',
      'settings.about': 'About App', 'settings.reset': 'Reset Progress',
      'settings.reset_confirm': 'Are you sure you want to reset all progress?',
      'quiz.title': 'Practice & Exam', 'quiz.start': 'Start', 'quiz.score': 'Score',
      'quiz.menu.particle': 'Particle Practice', 'quiz.menu.particle_desc': 'Fill in the correct particle',
      'common.level': 'Level', 'common.search': 'Search...', 'common.back': 'Back',
      // Content labels
      'content.meaning': 'Meaning', 'content.example': 'Example Sentence',
      'content.reading': 'Reading', 'content.on_reading': 'ONYOMI (Chinese)',
      'content.kun_reading': 'KUNYOMI (Japanese)', 'content.strokes': 'Strokes',
      'content.story': 'Kanji Story', 'content.vocab_examples': 'Vocabulary Examples',
      'content.grammar': 'Grammar', 'content.formula': 'Pattern / Formula',
      'content.explanation': 'Explanation', 'content.particle_usage': 'Usage',
      'content.level': 'Level', 'content.category': 'Category',
      'content.noun': 'Noun', 'content.verb': 'Verb',
      'content.adj': 'Adjective', 'content.other': 'Other', 'content.all': 'All',
      'content.search_kanji': 'Search kanji, meaning, or reading...',
      'content.search_vocab': 'Search words (Japanese/English)...',
      'content.search_grammar': 'Search grammar, pattern, or meaning...',
      'content.no_kanji': 'No kanji matches the search.',
      'content.no_vocab': 'No vocabulary in this category.',
      'content.no_grammar': 'No grammar matches.',
      'content.practice_write': 'Practice Writing',
      'content.detail': 'Detail', 'content.hide': 'Hide',
      'content.play': 'Play', 'content.stop': 'Stop',
    },
    VI: {
      'app.name': 'NihongoQuest',
      'nav.home': 'Trang chủ', 'nav.vocab': 'Từ vựng', 'nav.writing': 'Viết',
      'nav.profile': 'Hồ sơ', 'nav.settings': 'Cài đặt',
      'home.search_placeholder': 'Tìm Kanji, Từ vựng...',
      'home.start_learning': 'Bắt đầu học',
      'home.menu.kana': 'Kana', 'home.menu.kanji': 'Kanji',
      'home.menu.grammar': 'Ngữ pháp', 'home.menu.particles': 'Trợ từ',
      'home.menu.writing': 'Viết', 'home.menu.vocab': 'Từ vựng',
      'home.menu.quiz': 'Bài kiểm tra', 'home.menu.flashcard': 'Thẻ ghi nhớ',
      'flashcard.title': 'Thẻ ghi nhớ', 'flashcard.choose_deck': 'Chọn bộ bài',
      'flashcard.hiragana_deck': 'Bộ Hiragana', 'flashcard.katakana_deck': 'Bộ Katakana',
      'flashcard.kanji_deck': 'Bộ Kanji', 'flashcard.vocab_deck': 'Bộ Từ vựng',
      'flashcard.shuffle': 'Xáo bài', 'flashcard.card': 'Thẻ', 'flashcard.of': 'của',
      'flashcard.previous': 'Trước', 'flashcard.next': 'Tiếp',
      'flashcard.back_to_menu': 'Về menu',
      'flashcard.custom_deck': 'Tạo bộ bài mới', 'flashcard.custom_deck_desc': 'Tạo & lưu bộ bài của bạn',
      'flashcard.config_title': 'Trình soạn thảo bộ bài', 'flashcard.select_sources': 'Chọn nguồn bài',
      'flashcard.card_quantity': 'Số thẻ (1-500)', 'flashcard.start_session': 'Bắt đầu phiên',
      'flashcard.select_all': 'Chọn tất cả', 'flashcard.deselect_all': 'Bỏ chọn tất cả',
      'flashcard.deck_name': 'Tên bộ bài', 'flashcard.add_cards': 'Thêm thẻ',
      'flashcard.save_deck': 'Lưu bộ bài', 'flashcard.update_deck': 'Cập nhật bộ bài',
      'flashcard.my_decks': 'Bộ bài của tôi', 'flashcard.search_to_add': 'Tìm Kana, Kanji, Từ vựng...',
      'flashcard.add': 'Thêm', 'flashcard.added': 'Đã thêm',
      'flashcard.back_to_builder': 'Về trình soạn thảo', 'flashcard.delete': 'Xóa',
      'flashcard.delete_confirm': 'Bạn có chắc muốn xóa bộ bài "{deckName}"?',
      'flashcard.edit': 'Sửa', 'flashcard.start': 'Bắt đầu',
      'flashcard.no_custom_decks': 'Chưa có bộ bài nào. Tạo một bộ!',
      'flashcard.cards_in_deck': 'Thẻ trong bộ bài',
      'flashcard.browse_by_deck': 'Duyệt theo bộ bài',
      'flashcard.clear_category': 'Xóa bộ lọc',
      'flashcard.select_category_prompt': 'Chọn một danh mục để xem danh sách thẻ.',
      'flashcard.romaji_toggle': 'Romaji',
      'settings.title': 'Cài đặt', 'settings.language': 'Ngôn ngữ ứng dụng',
      'settings.theme': 'Giao diện', 'settings.dark_mode': 'Chế độ tối',
      'settings.about': 'Về ứng dụng', 'settings.reset': 'Đặt lại tiến độ',
      'settings.reset_confirm': 'Bạn có chắc muốn đặt lại tất cả tiến độ?',
      'quiz.title': 'Luyện tập & Thi', 'quiz.start': 'Bắt đầu', 'quiz.score': 'Điểm',
      'quiz.menu.particle': 'Luyện trợ từ', 'quiz.menu.particle_desc': 'Điền trợ từ đúng',
      'common.level': 'Cấp độ', 'common.search': 'Tìm kiếm...', 'common.back': 'Quay lại',
      'content.meaning': 'Nghĩa', 'content.example': 'Câu ví dụ',
      'content.reading': 'Cách đọc', 'content.on_reading': 'ONYOMI (Âm Hán)',
      'content.kun_reading': 'KUNYOMI (Âm Nhật)', 'content.strokes': 'Nét',
      'content.story': 'Câu chuyện Kanji', 'content.vocab_examples': 'Ví dụ từ vựng',
      'content.grammar': 'Ngữ pháp', 'content.formula': 'Cấu trúc / Công thức',
      'content.explanation': 'Giải thích', 'content.particle_usage': 'Cách dùng',
      'content.level': 'Cấp độ', 'content.category': 'Danh mục',
      'content.noun': 'Danh từ', 'content.verb': 'Động từ',
      'content.adj': 'Tính từ', 'content.other': 'Khác', 'content.all': 'Tất cả',
      'content.search_kanji': 'Tìm kanji, nghĩa, hoặc cách đọc...',
      'content.search_vocab': 'Tìm từ (Nhật/Việt)...',
      'content.search_grammar': 'Tìm ngữ pháp, cấu trúc...',
      'content.no_kanji': 'Không có Kanji phù hợp.', 'content.no_vocab': 'Không có từ vựng.',
      'content.no_grammar': 'Không có ngữ pháp phù hợp.',
      'content.practice_write': 'Luyện viết',
      'content.detail': 'Chi tiết', 'content.hide': 'Ẩn',
      'content.play': 'Phát', 'content.stop': 'Dừng',
    },
    MY: {
      'app.name': 'NihongoQuest',
      'nav.home': 'Utama', 'nav.vocab': 'Kosa Kata', 'nav.writing': 'Menulis',
      'nav.profile': 'Profil', 'nav.settings': 'Tetapan',
      'home.search_placeholder': 'Cari Kanji, Kosa Kata...',
      'home.start_learning': 'Mula Belajar',
      'home.menu.kana': 'Kana', 'home.menu.kanji': 'Kanji',
      'home.menu.grammar': 'Tatabahasa', 'home.menu.particles': 'Partikel',
      'home.menu.writing': 'Menulis', 'home.menu.vocab': 'Kosa Kata',
      'home.menu.quiz': 'Kuiz', 'home.menu.flashcard': 'Kad Imbas',
      'flashcard.title': 'Kad Imbas', 'flashcard.choose_deck': 'Pilih Dek',
      'flashcard.hiragana_deck': 'Dek Hiragana', 'flashcard.katakana_deck': 'Dek Katakana',
      'flashcard.kanji_deck': 'Dek Kanji', 'flashcard.vocab_deck': 'Dek Kosa Kata',
      'flashcard.shuffle': 'Kocok Kad', 'flashcard.card': 'Kad', 'flashcard.of': 'daripada',
      'flashcard.previous': 'Sebelum', 'flashcard.next': 'Seterusnya',
      'flashcard.back_to_menu': 'Kembali ke Menu',
      'flashcard.custom_deck': 'Buat Dek Baru', 'flashcard.custom_deck_desc': 'Buat & simpan dek anda sendiri',
      'flashcard.config_title': 'Editor Dek Kustom', 'flashcard.select_sources': 'Pilih Sumber Kad',
      'flashcard.card_quantity': 'Bilangan Kad (1-500)', 'flashcard.start_session': 'Mulakan Sesi',
      'flashcard.select_all': 'Pilih Semua', 'flashcard.deselect_all': 'Nyahpilih Semua',
      'flashcard.deck_name': 'Nama Dek', 'flashcard.add_cards': 'Tambah Kad',
      'flashcard.save_deck': 'Simpan Dek', 'flashcard.update_deck': 'Kemaskini Dek',
      'flashcard.my_decks': 'Dek Saya', 'flashcard.search_to_add': 'Cari Kana, Kanji, Kosa Kata...',
      'flashcard.add': 'Tambah', 'flashcard.added': 'Ditambah',
      'flashcard.back_to_builder': 'Kembali ke Editor', 'flashcard.delete': 'Padam',
      'flashcard.delete_confirm': 'Adakah anda pasti untuk memadam dek "{deckName}"?',
      'flashcard.edit': 'Edit', 'flashcard.start': 'Mula',
      'flashcard.no_custom_decks': 'Tiada dek kustom lagi. Buat satu!',
      'flashcard.cards_in_deck': 'Kad dalam Dek',
      'flashcard.browse_by_deck': 'Semak imbas mengikut Dek',
      'flashcard.clear_category': 'Kosongkan Penapis',
      'flashcard.select_category_prompt': 'Pilih kategori di atas untuk melihat senarai kad.',
      'flashcard.romaji_toggle': 'Romaji',
      'settings.title': 'Tetapan', 'settings.language': 'Bahasa Aplikasi',
      'settings.theme': 'Paparan', 'settings.dark_mode': 'Mod Gelap',
      'settings.about': 'Tentang Aplikasi', 'settings.reset': 'Set Semula Kemajuan',
      'settings.reset_confirm': 'Adakah anda pasti untuk memadam semua kemajuan?',
      'quiz.title': 'Latihan & Ujian', 'quiz.start': 'Mula', 'quiz.score': 'Markah',
      'quiz.menu.particle': 'Latihan Partikel', 'quiz.menu.particle_desc': 'Isi partikel yang betul',
      'common.level': 'Tahap', 'common.search': 'Cari...', 'common.back': 'Kembali',
      'content.meaning': 'Maksud', 'content.example': 'Contoh Ayat',
      'content.reading': 'Bacaan', 'content.on_reading': 'ONYOMI (Cina)',
      'content.kun_reading': 'KUNYOMI (Jepun)', 'content.strokes': 'Strok',
      'content.story': 'Cerita Kanji', 'content.vocab_examples': 'Contoh Kosa Kata',
      'content.grammar': 'Tatabahasa', 'content.formula': 'Pola / Formula',
      'content.explanation': 'Penjelasan', 'content.particle_usage': 'Penggunaan',
      'content.level': 'Tahap', 'content.category': 'Kategori',
      'content.noun': 'Kata Nama', 'content.verb': 'Kata Kerja',
      'content.adj': 'Kata Adjektif', 'content.other': 'Lain-lain', 'content.all': 'Semua',
      'content.search_kanji': 'Cari kanji, maksud, atau bacaan...',
      'content.search_vocab': 'Cari perkataan (Jepun/Melayu)...',
      'content.search_grammar': 'Cari tatabahasa, pola...',
      'content.no_kanji': 'Tiada Kanji yang sepadan.',
      'content.no_vocab': 'Tiada kosa kata dalam kategori ini.',
      'content.no_grammar': 'Tiada tatabahasa yang sepadan.',
      'content.practice_write': 'Latihan Menulis',
      'content.detail': 'Butiran', 'content.hide': 'Sembunyikan',
      'content.play': 'Main', 'content.stop': 'Henti',
    },
    TH: {
      'app.name': 'NihongoQuest',
      'nav.home': 'หน้าแรก', 'nav.vocab': 'คำศัพท์', 'nav.writing': 'เขียน',
      'nav.profile': 'โปรไฟล์', 'nav.settings': 'ตั้งค่า',
      'home.search_placeholder': 'ค้นหาคันจิ, คำศัพท์...',
      'home.start_learning': 'เริ่มเรียน',
      'home.menu.kana': 'คานะ', 'home.menu.kanji': 'คันจิ',
      'home.menu.grammar': 'ไวยากรณ์', 'home.menu.particles': 'คำช่วย',
      'home.menu.writing': 'เขียน', 'home.menu.vocab': 'คำศัพท์',
      'home.menu.quiz': 'ทดสอบ', 'home.menu.flashcard': 'แฟลชการ์ด',
      'flashcard.title': 'แฟลชการ์ด', 'flashcard.choose_deck': 'เลือกชุดบัตร',
      'flashcard.hiragana_deck': 'ชุดฮิระงะนะ', 'flashcard.katakana_deck': 'ชุดคะตะคะนะ',
      'flashcard.kanji_deck': 'ชุดคันจิ', 'flashcard.vocab_deck': 'ชุดคำศัพท์',
      'flashcard.shuffle': 'สุ่มบัตร', 'flashcard.card': 'บัตร', 'flashcard.of': 'จาก',
      'flashcard.previous': 'ก่อนหน้า', 'flashcard.next': 'ถัดไป',
      'flashcard.back_to_menu': 'กลับเมนู',
      'flashcard.custom_deck': 'สร้างชุดบัตรใหม่', 'flashcard.custom_deck_desc': 'สร้างและบันทึกชุดบัตรของคุณ',
      'flashcard.config_title': 'ตัวแก้ไขชุดบัตร', 'flashcard.select_sources': 'เลือกแหล่งบัตร',
      'flashcard.card_quantity': 'จำนวนบัตร (1-500)', 'flashcard.start_session': 'เริ่มรอบ',
      'flashcard.select_all': 'เลือกทั้งหมด', 'flashcard.deselect_all': 'ยกเลิกทั้งหมด',
      'flashcard.deck_name': 'ชื่อชุดบัตร', 'flashcard.add_cards': 'เพิ่มบัตร',
      'flashcard.save_deck': 'บันทึกชุดบัตร', 'flashcard.update_deck': 'อัปเดตชุดบัตร',
      'flashcard.my_decks': 'ชุดบัตรของฉัน', 'flashcard.search_to_add': 'ค้นหาคานะ, คันจิ, คำศัพท์...',
      'flashcard.add': 'เพิ่ม', 'flashcard.added': 'เพิ่มแล้ว',
      'flashcard.back_to_builder': 'กลับตัวแก้ไข', 'flashcard.delete': 'ลบ',
      'flashcard.delete_confirm': 'คุณแน่ใจหรือไม่ว่าต้องการลบชุดบัตร "{deckName}"?',
      'flashcard.edit': 'แก้ไข', 'flashcard.start': 'เริ่ม',
      'flashcard.no_custom_decks': 'ยังไม่มีชุดบัตร สร้างสักชุด!',
      'flashcard.cards_in_deck': 'บัตรในชุด',
      'flashcard.browse_by_deck': 'เรียกดูตามชุดบัตร',
      'flashcard.clear_category': 'ล้างตัวกรอง',
      'flashcard.select_category_prompt': 'เลือกหมวดหมู่เพื่อดูรายการบัตร',
      'flashcard.romaji_toggle': 'โรมาจิ',
      'settings.title': 'ตั้งค่า', 'settings.language': 'ภาษาแอป',
      'settings.theme': 'ธีม', 'settings.dark_mode': 'โหมดมืด',
      'settings.about': 'เกี่ยวกับแอป', 'settings.reset': 'รีเซ็ตความคืบหน้า',
      'settings.reset_confirm': 'คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตความคืบหน้าทั้งหมด?',
      'quiz.title': 'ฝึกซ้อมและสอบ', 'quiz.start': 'เริ่ม', 'quiz.score': 'คะแนน',
      'quiz.menu.particle': 'ฝึกคำช่วย', 'quiz.menu.particle_desc': 'เติมคำช่วยที่ถูกต้อง',
      'common.level': 'ระดับ', 'common.search': 'ค้นหา...', 'common.back': 'กลับ',
      'content.meaning': 'ความหมาย', 'content.example': 'ประโยคตัวอย่าง',
      'content.reading': 'การอ่าน', 'content.on_reading': 'ออนโยมิ (จีน)',
      'content.kun_reading': 'คุนโยมิ (ญี่ปุ่น)', 'content.strokes': 'จำนวนเส้น',
      'content.story': 'เรื่องราวคันจิ', 'content.vocab_examples': 'ตัวอย่างคำศัพท์',
      'content.grammar': 'ไวยากรณ์', 'content.formula': 'รูปแบบ / สูตร',
      'content.explanation': 'คำอธิบาย', 'content.particle_usage': 'การใช้งาน',
      'content.level': 'ระดับ', 'content.category': 'หมวดหมู่',
      'content.noun': 'คำนาม', 'content.verb': 'คำกริยา',
      'content.adj': 'คำคุณศัพท์', 'content.other': 'อื่นๆ', 'content.all': 'ทั้งหมด',
      'content.search_kanji': 'ค้นหาคันจิ, ความหมาย...',
      'content.search_vocab': 'ค้นหาคำ (ญี่ปุ่น/ไทย)...',
      'content.search_grammar': 'ค้นหาไวยากรณ์, รูปแบบ...',
      'content.no_kanji': 'ไม่พบคันจิที่ตรงกัน', 'content.no_vocab': 'ไม่มีคำศัพท์',
      'content.no_grammar': 'ไม่พบไวยากรณ์ที่ตรงกัน',
      'content.practice_write': 'ฝึกเขียน',
      'content.detail': 'รายละเอียด', 'content.hide': 'ซ่อน',
      'content.play': 'เล่น', 'content.stop': 'หยุด',
    },
    PH: {
      'app.name': 'NihongoQuest',
      'nav.home': 'Home', 'nav.vocab': 'Bokabularyo', 'nav.writing': 'Pagsulat',
      'nav.profile': 'Profile', 'nav.settings': 'Settings',
      'home.search_placeholder': 'Maghanap ng Kanji, Bokabularyo...',
      'home.start_learning': 'Magsimulang Matuto',
      'home.menu.kana': 'Kana', 'home.menu.kanji': 'Kanji',
      'home.menu.grammar': 'Gramatika', 'home.menu.particles': 'Particle',
      'home.menu.writing': 'Pagsulat', 'home.menu.vocab': 'Bokabularyo',
      'home.menu.quiz': 'Pagsusulit', 'home.menu.flashcard': 'Flashcard',
      'flashcard.title': 'Flashcard', 'flashcard.choose_deck': 'Pumili ng Deck',
      'flashcard.hiragana_deck': 'Deck Hiragana', 'flashcard.katakana_deck': 'Deck Katakana',
      'flashcard.kanji_deck': 'Deck Kanji', 'flashcard.vocab_deck': 'Deck Bokabularyo',
      'flashcard.shuffle': 'I-shuffle ang Mga Kard', 'flashcard.card': 'Kard', 'flashcard.of': 'ng',
      'flashcard.previous': 'Nakaraan', 'flashcard.next': 'Susunod',
      'flashcard.back_to_menu': 'Bumalik sa Menu',
      'flashcard.custom_deck': 'Bagong Custom Deck', 'flashcard.custom_deck_desc': 'Gumawa at mag-save ng sariling deck',
      'flashcard.config_title': 'Custom Deck Editor', 'flashcard.select_sources': 'Piliin ang Mga Pinagkukunan',
      'flashcard.card_quantity': 'Bilang ng Kard (1-500)', 'flashcard.start_session': 'Simulan ang Sesyon',
      'flashcard.select_all': 'Piliin Lahat', 'flashcard.deselect_all': 'I-deselect Lahat',
      'flashcard.deck_name': 'Pangalan ng Deck', 'flashcard.add_cards': 'Magdagdag ng Kard',
      'flashcard.save_deck': 'I-save ang Deck', 'flashcard.update_deck': 'I-update ang Deck',
      'flashcard.my_decks': 'Aking Mga Deck', 'flashcard.search_to_add': 'Maghanap ng Kana, Kanji, Bokabularyo...',
      'flashcard.add': 'Idagdag', 'flashcard.added': 'Naidagdag',
      'flashcard.back_to_builder': 'Bumalik sa Editor', 'flashcard.delete': 'I-delete',
      'flashcard.delete_confirm': 'Sigurado ka bang gusto mong i-delete ang deck na "{deckName}"?',
      'flashcard.edit': 'I-edit', 'flashcard.start': 'Simulan',
      'flashcard.no_custom_decks': 'Wala pang custom deck. Gumawa ng isa!',
      'flashcard.cards_in_deck': 'Mga Kard sa Deck',
      'flashcard.browse_by_deck': 'Mag-browse ayon sa Deck',
      'flashcard.clear_category': 'I-clear ang Filter',
      'flashcard.select_category_prompt': 'Pumili ng kategorya para makita ang listahan ng kard.',
      'flashcard.romaji_toggle': 'Romaji',
      'settings.title': 'Settings', 'settings.language': 'Wika ng App',
      'settings.theme': 'Hitsura', 'settings.dark_mode': 'Dark Mode',
      'settings.about': 'Tungkol sa App', 'settings.reset': 'I-reset ang Progreso',
      'settings.reset_confirm': 'Sigurado ka bang gusto mong i-reset ang lahat ng progreso?',
      'quiz.title': 'Pagsasanay at Pagsusulit', 'quiz.start': 'Simulan', 'quiz.score': 'Puntos',
      'quiz.menu.particle': 'Pagsasanay sa Particle', 'quiz.menu.particle_desc': 'Punan ang tamang particle',
      'common.level': 'Antas', 'common.search': 'Maghanap...', 'common.back': 'Bumalik',
      'content.meaning': 'Kahulugan', 'content.example': 'Halimbawang Pangungusap',
      'content.reading': 'Pagbasa', 'content.on_reading': 'ONYOMI (Tsino)',
      'content.kun_reading': 'KUNYOMI (Hapon)', 'content.strokes': 'Bilang ng Stroke',
      'content.story': 'Kwento ng Kanji', 'content.vocab_examples': 'Mga Halimbawa ng Bokabularyo',
      'content.grammar': 'Gramatika', 'content.formula': 'Istruktura / Formula',
      'content.explanation': 'Paliwanag', 'content.particle_usage': 'Paggamit',
      'content.level': 'Antas', 'content.category': 'Kategorya',
      'content.noun': 'Pangngalan', 'content.verb': 'Pandiwa',
      'content.adj': 'Pang-uri', 'content.other': 'Iba pa', 'content.all': 'Lahat',
      'content.search_kanji': 'Maghanap ng kanji, kahulugan...',
      'content.search_vocab': 'Maghanap ng salita (Hapon/Filipino)...',
      'content.search_grammar': 'Maghanap ng gramatika, istruktura...',
      'content.no_kanji': 'Walang Kanji na tumutugma.', 'content.no_vocab': 'Walang bokabularyo.',
      'content.no_grammar': 'Walang gramatika na tumutugma.',
      'content.practice_write': 'Magsanay ng Pagsulat',
      'content.detail': 'Detalye', 'content.hide': 'Itago',
      'content.play': 'I-play', 'content.stop': 'Ihinto',
    },
  };

  private safeGet(key: string): string | null {
    try { return localStorage.getItem(key); } catch { return null; }
  }
  private safeSet(key: string, value: string): void {
    try { localStorage.setItem(key, value); } catch { /* ignore */ }
  }

  constructor() {
    try {
      const savedLang = this.safeGet('app_lang') as LanguageCode;
      if (savedLang && this.dictionary[savedLang]) this.currentLang.set(savedLang);
      const savedTheme = this.safeGet('app_theme');
      if (savedTheme) this.isDarkMode.set(savedTheme === 'dark');
    } catch { /* ignore */ }
  }

  setLanguage(lang: LanguageCode) {
    this.currentLang.set(lang);
    this.safeSet('app_lang', lang);
  }

  toggleTheme() {
    this.isDarkMode.update(v => !v);
    this.safeSet('app_theme', this.isDarkMode() ? 'dark' : 'light');
  }

  get(key: string): string {
    const lang = this.currentLang();
    return this.dictionary[lang]?.[key] || this.dictionary['EN']?.[key] || key;
  }

  /**
   * Translate content text (meanings, explanations, etc.)
   * Uses all content maps. Falls back to Indonesian if no translation found.
   */
  c(text: string): string {
    if (!text) return text;
    const lang = this.currentLang() as ContentLang;
    if (lang === 'ID') return text; // ID is the source language

    // For EN: try exact match in all maps (priority order)
    const allMaps = [MEANING_MAP, GRAMMAR_FULL_MAP, PARTICLE_MAP, PARTICLE_EXPLANATION_MAP, GRAMMAR_MAP];
    for (const map of allMaps) {
      if (map[text]?.[lang]) return map[text][lang]!;
    }

    // For shorter text not in map, return original
    return text;
  }

  getLangName(code: LanguageCode): string {
    switch(code) {
      case 'ID': return 'Bahasa Indonesia';
      case 'EN': return 'English';
      case 'VI': return 'Tiếng Việt';
      case 'TH': return 'ไทย (Thai)';
      case 'PH': return 'Filipino';
      case 'MY': return 'Bahasa Melayu';
      default: return code;
    }
  }
}
